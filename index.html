<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alive Rotation</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { padding: 10px; }
    .card{
      max-width: 980px; margin: 0 auto; padding: 18px 18px 16px;
      border-radius: 18px; border: 1px solid rgba(127,127,127,.25);
      box-shadow: 0 8px 30px rgba(0,0,0,.08);
      background: rgba(255,255,255,.02);
    }
    .kicker { opacity:.75; font-size: 14px; letter-spacing: .08em; text-transform: uppercase; }
    h1 { margin: 6px 0 6px; font-size: 26px; }
    .meta { opacity:.80; font-size: 13px; margin-top: 6px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; align-items: center; }
    .chip{
      padding: 10px 12px; border-radius: 14px;
      background: rgba(127,127,127,.12);
      font-size: 13px;
      border: 1px solid rgba(127,127,127,.18);
    }
    .small { opacity:.75; font-weight: 500; }
    .btn {
      appearance:none; border: 1px solid rgba(127,127,127,.25);
      background: rgba(127,127,127,.12);
      border-radius: 14px; padding: 10px 12px;
      cursor: pointer; font-weight: 700;
    }

    .twoCol {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 820px) {
      .twoCol { grid-template-columns: 1fr; }
    }

    .panel {
      border-radius: 18px;
      border: 1px solid rgba(127,127,127,.18);
      background: rgba(127,127,127,.06);
      padding: 12px;
    }
    .panelTitle {
      display:flex; justify-content: space-between; align-items: baseline;
      margin-bottom: 10px;
    }
    .panelTitle h2 {
      margin: 0;
      font-size: 16px;
      letter-spacing: .02em;
    }
    .count {
      opacity:.75;
      font-size: 12px;
    }

    .grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 10px;
    }

    /* Alive vs Protected color-coding */
    .pill{
      padding: 12px 14px; border-radius: 14px;
      font-weight: 800;
      text-align:center;
      border: 1px solid rgba(127,127,127,.18);
    }
    .pillAlive{
      background: rgba(34, 197, 94, .18); /* green tint */
      border-color: rgba(34, 197, 94, .35);
    }
    .pillProtected{
      background: rgba(148, 163, 184, .18); /* slate tint */
      border-color: rgba(148, 163, 184, .35);
      font-weight: 700;
    }

    .legendDot {
      display:inline-block; width:10px; height:10px; border-radius: 999px; margin-right: 6px;
      vertical-align: middle;
    }
    .dotAlive { background: rgba(34, 197, 94, .85); }
    .dotProtected { background: rgba(148, 163, 184, .85); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Alive Window</h1>

      <div class="meta" id="windowLabel"></div>

      <div class="row">
        <div class="chip">
          <span class="">Next rotation in:</span>
          <span id="countdown" style="font-weight:800;"></span>
        </div>
        <div class="chip"><span class="small">Timezone:</span> America/New_York</div>
        <div class="chip">
          <span class="legendDot dotAlive"></span><span class="small">Alive</span>
          &nbsp;&nbsp;
          <span class="legendDot dotProtected"></span><span class="small">Protected</span>
        </div>
        <button class="btn" id="refreshBtn" title="Recompute (same result within the same window)">Refresh</button>
      </div>

      <div class="twoCol">
        <div class="panel">
          <div class="panelTitle">
            <h2>âœ… Alive (scorable)</h2>
            <div class="count" id="aliveCount"></div>
          </div>
          <div class="grid" id="alive"></div>
        </div>

        <div class="panel">
          <div class="panelTitle">
            <h2>ðŸ›¡ Protected (immune)</h2>
            <div class="count" id="protectedCount"></div>
          </div>
          <div class="grid" id="protected"></div>
        </div>
      </div>

      <div class="meta" style="margin-top:12px;">
        Rule of thumb: only the <b>Alive</b> list can be hit/scored during this window. Everyone else is <b>Protected</b>.
      </div>
    </div>
  </div>

<script>
  // ================= CONFIG =================
  const TZ = "America/New_York";
  const WINDOW_HOURS = 1;
  const ALIVE_COUNT = 5;

  // Align the windows to your workday if you want (e.g., 8am start):
  // 0 = midnight aligned; 8 = windows start at 8:00, 11:00, 2:00, etc.
  const WINDOW_START_HOUR_OFFSET = 8;

  // Replace with your active players (must match how you spell names elsewhere)
  const PLAYERS = [
    "Andy", "Ben", "Cal", "DeRo", "Gabe", "KP", "Sean", "Steph",
    "Stephen", "Will", "Adam", "Alex Nye", "Ari",
    "Danny", "Lamar", "Meetch", "Stroot"
  ];
  // =========================================
  // ====== Google Form Prefill (EDIT THESE) ======
  const FORM_BASE = "PASTE_YOUR_PREFILLED_LINK_BASE_HERE"; 
  // IMPORTANT: FORM_BASE should be the form URL up to "...viewform?usp=pp_url" (no entry params)
  
  const ENTRY_SHOOTER   = "entry.111111111111";  // replace
  const ENTRY_TARGET    = "entry.222222222222";  // replace
  const ENTRY_EVENTTYPE = "entry.333333333333";  // replace
  const ENTRY_QTY       = "entry.444444444444";  // replace
  const ENTRY_CONFIRMED = "entry.555555555555";  // replace
  // Optional if you have a Date question:
  const ENTRY_DATE      = ""; // e.g. "entry.666666666666" or leave "" if not used


  // Seeded PRNG (deterministic)
  function xmur3(str) {
    let h = 1779033703 ^ str.length;
    for (let i = 0; i < str.length; i++) {
      h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
      h = (h << 13) | (h >>> 19);
    }
    return function() {
      h = Math.imul(h ^ (h >>> 16), 2246822507);
      h = Math.imul(h ^ (h >>> 13), 3266489909);
      return (h ^= h >>> 16) >>> 0;
    };
  }
  function mulberry32(a) {
    return function() {
      let t = (a += 0x6D2B79F5);
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }

  function nowPartsInTZ() {
    const parts = new Intl.DateTimeFormat("en-US", {
      timeZone: TZ,
      year:"numeric", month:"2-digit", day:"2-digit",
      hour:"2-digit", minute:"2-digit", second:"2-digit",
      hour12:false
    }).formatToParts(new Date());
    const get = (t) => parts.find(p => p.type === t)?.value;
    return {
      y: +get("year"),
      m: +get("month"),
      d: +get("day"),
      hh: +get("hour"),
      mm: +get("minute"),
      ss: +get("second"),
    };
  }

  function seededShuffle(arr, rng) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(rng() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function pad2(n){ return String(n).padStart(2,"0"); }

  function fmtTimeLabel(y,m,d,h,minute=0) {
    const dt = new Date(y, m-1, d, h, minute, 0);
    return new Intl.DateTimeFormat("en-US", {
      timeZone: TZ, hour:"numeric", minute:"2-digit"
    }).format(dt);
  }

  function computeWindow(p) {
    // shift hour by offset so windows align to workday
    const shiftedHour = (p.hh - WINDOW_START_HOUR_OFFSET + 24) % 24;
    const blockIndex = Math.floor(shiftedHour / WINDOW_HOURS); // 0..(24/WINDOW_HOURS - 1)
    const startHour = (blockIndex * WINDOW_HOURS + WINDOW_START_HOUR_OFFSET) % 24;
    const endHour = (startHour + WINDOW_HOURS);

    // seed changes only on date + blockIndex + offset
    const seedStr = `${p.y}-${pad2(p.m)}-${pad2(p.d)}-block${blockIndex}-offset${WINDOW_START_HOUR_OFFSET}`;
    const seedFn = xmur3(seedStr);
    const rng = mulberry32(seedFn());

    // compute next rotation (end of this window)
    let nextY = p.y, nextM = p.m, nextD = p.d, nextH = endHour;
    if (nextH >= 24) {
      const dt = new Date(p.y, p.m - 1, p.d, 0, 0, 0);
      dt.setDate(dt.getDate() + 1);
      nextY = dt.getFullYear();
      nextM = dt.getMonth() + 1;
      nextD = dt.getDate();
      nextH = endHour - 24;
    }
    const nextRotation = new Date(nextY, nextM - 1, nextD, nextH, 0, 0);

    // window label
    const startLabel = fmtTimeLabel(p.y, p.m, p.d, startHour, 0);
    let endLabel;
    if (endHour >= 24) {
      const dt = new Date(p.y, p.m - 1, p.d, 0, 0, 0);
      dt.setDate(dt.getDate() + 1);
      endLabel = fmtTimeLabel(dt.getFullYear(), dt.getMonth()+1, dt.getDate(), endHour-24, 0);
    } else {
      endLabel = fmtTimeLabel(p.y, p.m, p.d, endHour, 0);
    }

    const dateLabel = new Intl.DateTimeFormat("en-US", {
      timeZone: TZ, weekday:"long", month:"short", day:"numeric"
    }).format(new Date(p.y, p.m-1, p.d, 12, 0, 0));

    const windowLabel = `Window: ${dateLabel} â€¢ ${startLabel} â€“ ${endLabel} ET`;

    return { rng, nextRotation, windowLabel };
  }
  
  function openPrefilledHitForm(targetName) {
    const shooter = prompt("Shooter name (exact match from Players list):");
    if (!shooter) return;
  
    const params = new URLSearchParams();
    params.set(ENTRY_SHOOTER, shooter);
    params.set(ENTRY_TARGET, targetName);
    params.set(ENTRY_EVENTTYPE, "Hit");
    params.set(ENTRY_QTY, "1");
    params.set(ENTRY_CONFIRMED, "Yes");
  
    if (ENTRY_DATE) {
      const p = nowPartsInTZ();
      const dateStr = `${p.m}/${p.d}/${p.y}`;
      params.set(ENTRY_DATE, dateStr);
    }
  
    const url = `${FORM_BASE}&${params.toString()}`;
    window.open(url, "_blank", "noopener,noreferrer");
  }

  function render() {
    const p = nowPartsInTZ();
    const { rng, nextRotation, windowLabel } = computeWindow(p);

    // choose alive list deterministically
    const shuffled = seededShuffle(PLAYERS, rng);
    const alive = shuffled.slice(0, Math.min(ALIVE_COUNT, shuffled.length));
    const aliveSet = new Set(alive);

    // protected = everyone else
    const protectedList = PLAYERS.filter(n => !aliveSet.has(n));

    document.getElementById("windowLabel").textContent = windowLabel;

    document.getElementById("alive").innerHTML =
      alive.map(n => `<div class="pill pillAlive pillClickable" data-name="${n}">âœ… ${n}</div>`).join("");
    //document.getElementById("alive").innerHTML =
      //alive.map(n => `<div class="pill pillAlive">âœ… ${n}</div>`).join("");
    document.querySelectorAll("#alive .pillClickable").forEach(el => {
      el.style.cursor = "pointer";
      el.title = "Click to log a hit (opens form)";
      el.addEventListener("click", () => {
        const name = el.getAttribute("data-name");
        openPrefilledHitForm(name);
      });
    });

    document.getElementById("protected").innerHTML =
      protectedList.map(n => `<div class="pill pillProtected">ðŸ›¡ ${n}</div>`).join("");

    document.getElementById("aliveCount").textContent = `${alive.length} of ${PLAYERS.length}`;
    document.getElementById("protectedCount").textContent = `${protectedList.length} of ${PLAYERS.length}`;

    // countdown to next rotation
    const now = new Date(p.y, p.m-1, p.d, p.hh, p.mm, p.ss);
    const diffMs = nextRotation.getTime() - now.getTime();
    const totalSec = Math.max(0, Math.floor(diffMs / 1000));
    const hh = Math.floor(totalSec / 3600);
    const mm = Math.floor((totalSec % 3600) / 60);
    const ss = totalSec % 60;
    document.getElementById("countdown").textContent =
      `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
  }

  render();
  setInterval(render, 1000);
  document.getElementById("refreshBtn").addEventListener("click", render);
</script>
</body>
</html>
